{{ define "bucket_policy" }}
<div class="space-y-4" x-data="{
    policyType: '{{ .PolicyType }}',
    customPolicy: '',
    showEditor: {{ if eq .PolicyType "custom" }}true{{ else }}false{{ end }},
    init() {
        const el = this.$refs.policyData;
        if (el && el.value) this.customPolicy = el.value;
    }
}">
    <textarea x-ref="policyData" class="hidden">{{ .FormattedPolicy }}</textarea>
    {{ if .Error }}
    <div class="bg-red-500/10 border border-red-500/20 text-red-400 rounded-lg p-3 text-sm">
        <i data-lucide="alert-circle" size="16" class="inline mr-1"></i>
        {{ .Error }}
    </div>
    {{ end }}

    <!-- Current Policy Display -->
    {{ if .HasPolicy }}
    <div class="bg-zinc-800/50 rounded-lg p-3">
        <div class="flex items-center justify-between mb-2">
            <span class="text-zinc-500 text-xs">Current Policy</span>
            {{ if eq .PolicyType "private" }}
            <span class="text-xs bg-zinc-500/10 text-zinc-400 px-2 py-0.5 rounded">Private</span>
            {{ else if eq .PolicyType "public-read" }}
            <span class="text-xs bg-emerald-500/10 text-emerald-400 px-2 py-0.5 rounded">Public Read</span>
            {{ else if eq .PolicyType "public-read-write" }}
            <span class="text-xs bg-yellow-500/10 text-yellow-400 px-2 py-0.5 rounded">Public Read/Write</span>
            {{ else }}
            <span class="text-xs bg-accent/10 text-accent px-2 py-0.5 rounded">Custom</span>
            {{ end }}
        </div>
        <pre class="text-xs text-zinc-300 overflow-x-auto max-h-48 overflow-y-auto bg-zinc-900 rounded p-2 font-mono">{{ .FormattedPolicy }}</pre>
    </div>
    {{ else }}
    <div class="text-center py-4 text-zinc-500">
        <i data-lucide="lock" size="24" class="mx-auto mb-2 opacity-50"></i>
        <p class="text-sm">No policy configured (Private)</p>
        <p class="text-xs mt-1">Only the bucket owner can access objects</p>
    </div>
    {{ end }}

    <!-- Policy Selection Form -->
    <form hx-post="/buckets/{{ .BucketName }}/policy" class="space-y-4 pt-4 border-t border-zinc-700">
        <div>
            <label class="block text-xs text-zinc-500 mb-2">Access Policy</label>
            <div class="grid grid-cols-2 gap-2">
                <label class="flex items-center gap-2 p-3 bg-zinc-800/50 rounded-lg cursor-pointer border border-transparent hover:border-zinc-600 transition-colors"
                    :class="{ 'border-accent': policyType === 'private' }">
                    <input type="radio" name="policyType" value="private" x-model="policyType" @change="showEditor = false"
                        class="text-accent focus:ring-accent" />
                    <div>
                        <div class="text-sm text-white font-medium">Private</div>
                        <div class="text-xs text-zinc-500">Owner only</div>
                    </div>
                </label>
                <label class="flex items-center gap-2 p-3 bg-zinc-800/50 rounded-lg cursor-pointer border border-transparent hover:border-zinc-600 transition-colors"
                    :class="{ 'border-accent': policyType === 'public-read' }">
                    <input type="radio" name="policyType" value="public-read" x-model="policyType" @change="showEditor = false"
                        class="text-accent focus:ring-accent" />
                    <div>
                        <div class="text-sm text-white font-medium">Public Read</div>
                        <div class="text-xs text-zinc-500">Anyone can read</div>
                    </div>
                </label>
                <label class="flex items-center gap-2 p-3 bg-zinc-800/50 rounded-lg cursor-pointer border border-transparent hover:border-zinc-600 transition-colors"
                    :class="{ 'border-accent': policyType === 'public-read-write' }">
                    <input type="radio" name="policyType" value="public-read-write" x-model="policyType" @change="showEditor = false"
                        class="text-accent focus:ring-accent" />
                    <div>
                        <div class="text-sm text-white font-medium">Public Read/Write</div>
                        <div class="text-xs text-zinc-500">Anyone can read/write</div>
                    </div>
                </label>
                <label class="flex items-center gap-2 p-3 bg-zinc-800/50 rounded-lg cursor-pointer border border-transparent hover:border-zinc-600 transition-colors"
                    :class="{ 'border-accent': policyType === 'custom' }">
                    <input type="radio" name="policyType" value="custom" x-model="policyType" @change="showEditor = true"
                        class="text-accent focus:ring-accent" />
                    <div>
                        <div class="text-sm text-white font-medium">Custom</div>
                        <div class="text-xs text-zinc-500">JSON policy</div>
                    </div>
                </label>
            </div>
        </div>

        <!-- Custom Policy Editor -->
        <div x-show="showEditor" x-cloak class="space-y-2">
            <label class="block text-xs text-zinc-500">Policy JSON</label>
            <textarea name="policy" x-model="customPolicy" rows="10"
                class="w-full bg-zinc-900 border border-zinc-700 rounded-lg px-3 py-2 text-sm text-white font-mono placeholder-zinc-500 focus:border-accent focus:outline-none"
                placeholder='{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {"AWS": ["*"]},
      "Action": ["s3:GetObject"],
      "Resource": ["arn:aws:s3:::{{ .BucketName }}/*"]
    }
  ]
}'></textarea>
            <p class="text-xs text-zinc-500">
                <i data-lucide="info" size="12" class="inline mr-1"></i>
                Use AWS IAM policy format. Leave empty to remove the policy.
            </p>
        </div>

        <div class="flex gap-2">
            <button type="submit" class="bg-accent hover:bg-accent/80 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                <i data-lucide="save" size="14" class="inline mr-1"></i>
                Apply Policy
            </button>
        </div>
    </form>
</div>
{{ end }}